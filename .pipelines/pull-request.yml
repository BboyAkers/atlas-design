# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

name: Pull Request

trigger: none

pr:
  autoCancel: true
  drafts: true

pool:
  vmImage: windows-latest

steps:
  - task: NodeTool@0
    displayName: Use node 15.7.x
    inputs:
      versionSpec: '15.7.x'

  - script: npm config set python python2.7
    displayName: Use Python 2.7

  - script: npm install --global --production windows-build-tools --vs2017
    displayName: Install Windows build tools for Visual Studio 2017

  - script: npm config set msvs_version 2017 --global
    displayName: Set Visual Studio to 2017

  - script: npm config set msbuild_path "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\MSBuild\15.0\Bin\MsBuild.exe"
    displayName: Set Visual Studio msbuild path

  - script: npm ci --no-optional
    displayName: Install

  - script: npm run lint
    displayName: Lint

  - script: npm run build:site  --dist-dir "dist/pulls/$(System.PullRequest.PullRequestNumber)" --public-url "/pulls/$(System.PullRequest.PullRequestNumber)"
    displayName: Build site

  - task: AzureFileCopy@4
    displayName: Deploy site
    inputs:
      sourcePath: $(System.DefaultWorkingDirectory)/site/dist/*
      azureSubscription: 'MSFTDOCS - AtlasDesign Content Publisher'
      destination: azureBlob
      storage: atlasdesignpublic
      containerName: $web
